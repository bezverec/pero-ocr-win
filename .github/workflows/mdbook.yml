name: Deploy mdBook documentation to Pages

on:
  push:
    branches: ["master"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      MDBOOK_VERSION: 0.4.36
    steps:
      - uses: actions/checkout@v4
      
      - name: Create SUMMARY.md if missing
        run: |
          cd win-docs
          if [ ! -f SUMMARY.md ]; then
            cat > SUMMARY.md << 'EOF'
# Summary

[PERO OCR for Windows – Documentation Index](INDEX.md)

## Installation & Environment
- [Windows installation](win-install.md)
- [GPU, CUDA and PyTorch setup](gpu-cuda-pytorch.md)

## OCR Outputs & Formats
- [ALTO versions and conversion](alto-versions.md)

## Practical Usage
- [Workflow examples (OCR → ALTO → TXT)](workflow-examples.md)

## Project Context
- [About this fork and upstream project](README-upstream.md)
EOF
          fi
      
      - name: Create mdbook.toml if missing
        run: |
          if [ ! -f mdbook.toml ]; then
            cat > mdbook.toml << 'EOF'
[book]
title = "Pero OCR Windows - Documentation"
description = "Windows-focused fork of PERO OCR project"
authors = ["bezverec"]
src = "win-docs"

[build]
build-dir = "_site"
create-missing = true

[output.html]
default-theme = "dark"
preferred-dark-theme = "dark"
EOF
          fi
      
      - name: Install mdBook
        run: |
          curl -sSf https://sh.rustup.rs | sh -s -- -y
          export PATH="$HOME/.cargo/bin:$PATH"
          cargo install --version ${MDBOOK_VERSION} mdbook
      
      - name: Build with mdBook
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          mdbook build
          
          # Přidat .nojekyll soubor pro GitHub Pages
          touch _site/.nojekyll
      
      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v5
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_site

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      - name: Add custom CSS
        run: |
          # Vytvořit custom CSS soubor
          cat > _site/css/custom.css << 'EOF'
          /* Custom styles for Pero OCR documentation */
          :root {
            --md-primary-fg-color: #238636;
            --md-primary-fg-color--light: #2ea043;
            --md-primary-fg-color--dark: #1f6f3b;
          }
          
          .md-header {
            background: linear-gradient(90deg, #161b22, #0d1117);
          }
          
          .md-typeset code {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            padding: 0.2em 0.4em;
          }
          
          .md-typeset pre > code {
            background-color: #161b22;
            border: 1px solid #30363d;
          }
          
          /* PowerShell syntax highlighting */
          .language-powershell .c, .language-powershell .c1 {
            color: #6e7681;
            font-style: italic;
          }
          EOF
          
          # Přidat CSS do všech HTML souborů
          for file in _site/**/*.html; do
            sed -i 's|</head>|  <link rel="stylesheet" href="css/custom.css">\n</head>|' "$file"
          done

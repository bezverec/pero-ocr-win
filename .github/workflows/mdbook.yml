name: Deploy mdBook documentation to Pages

on:
  push:
    branches: ["master"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      MDBOOK_VERSION: 0.4.36
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python for debugging
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Debug - list files before build
        run: |
          echo "=== Current directory structure ==="
          find . -type f -name "*.md" | head -20
          echo ""
          echo "=== win-docs directory ==="
          ls -la win-docs/ || echo "win-docs not found"
      
      - name: Create simple mdbook structure
        run: |
          # Vytvořit src adresář
          mkdir -p src
          
          # Přesunout md soubory z win-docs do src
          if [ -d "win-docs" ]; then
            cp win-docs/*.md src/ 2>/dev/null || echo "No .md files to copy"
          fi
          
          # Vytvořit SUMMARY.md
          echo '# Summary' > src/SUMMARY.md
          echo '' >> src/SUMMARY.md
          echo '[PERO OCR for Windows – Documentation Index](INDEX.md)' >> src/SUMMARY.md
          echo '' >> src/SUMMARY.md
          echo '## Installation & Environment' >> src/SUMMARY.md
          echo '- [Windows installation](win-install.md)' >> src/SUMMARY.md
          echo '- [GPU, CUDA and PyTorch setup](gpu-cuda-pytorch.md)' >> src/SUMMARY.md
          echo '' >> src/SUMMARY.md
          echo '## OCR Outputs & Formats' >> src/SUMMARY.md
          echo '- [ALTO versions and conversion](alto-versions.md)' >> src/SUMMARY.md
          echo '' >> src/SUMMARY.md
          echo '## Practical Usage' >> src/SUMMARY.md
          echo '- [Workflow examples (OCR → ALTO → TXT)](workflow-examples.md)' >> src/SUMMARY.md
          echo '' >> src/SUMMARY.md
          echo '## Project Context' >> src/SUMMARY.md
          echo '- [About this fork and upstream project](README-upstream.md)' >> src/SUMMARY.md
          
          # Vytvořit jednoduchý mdbook.toml v kořeni
          echo '[book]' > mdbook.toml
          echo 'title = "Pero OCR Windows - Documentation"' >> mdbook.toml
          echo 'description = "Windows-focused fork of PERO OCR project"' >> mdbook.toml
          echo 'authors = ["bezverec"]' >> mdbook.toml
          echo 'src = "src"' >> mdbook.toml
          echo '' >> mdbook.toml
          echo '[build]' >> mdbook.toml
          echo 'build-dir = "book"' >> mdbook.toml  # Standardní mdBook výstup
          echo '' >> mdbook.toml
          echo '[output.html]' >> mdbook.toml
          echo 'default-theme = "dark"' >> mdbook.toml
      
      - name: Install mdBook
        run: |
          curl -sSf https://sh.rustup.rs | sh -s -- -y
          export PATH="$HOME/.cargo/bin:$PATH"
          cargo install --version ${MDBOOK_VERSION} mdbook
      
      - name: Build with mdBook
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          echo "=== Building mdBook ==="
          mdbook build
          echo "=== Build completed ==="
      
      - name: Debug - find mdBook output
        run: |
          echo "=== Looking for mdBook output ==="
          find . -type d -name "book" -o -name "_site" -o -name "html" | head -10
          echo ""
          echo "=== Checking book directory ==="
          if [ -d "book" ]; then
            ls -la book/
            echo "Book directory exists with $(find book -type f | wc -l) files"
          else
            echo "No 'book' directory found"
          fi
      
      - name: Prepare for GitHub Pages
        run: |
          # Vytvořit _site adresář (co GitHub Pages očekává)
          rm -rf _site
          mkdir -p _site
          
          # Zkopírovat výstup z mdBook do _site
          if [ -d "book" ]; then
            echo "Copying from 'book' directory"
            cp -r book/* _site/
          elif [ -d "_site" ]; then
            echo "_site already exists"
          else
            echo "No output found, creating simple redirect"
            echo '<!DOCTYPE html>
            <html>
            <head>
                <title>Pero OCR Windows - Documentation</title>
                <meta http-equiv="refresh" content="0; url=https://github.com/bezverec/pero-ocr-win/tree/master/win-docs">
            </head>
            <body>
                <p>Redirecting to documentation on GitHub...</p>
            </body>
            </html>' > _site/index.html
          fi
          
          # Přidat .nojekyll
          touch _site/.nojekyll
          
          # Vytvořit proper index.html pokud neexistuje
          if [ ! -f "_site/index.html" ]; then
            echo "Creating index.html redirect"
            echo '<!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>Redirecting</title>
                <meta http-equiv="refresh" content="0; url=./">
            </head>
            <body>
                <p>Redirecting...</p>
            </body>
            </html>' > _site/index.html
          fi
          
          echo "=== Final _site contents ==="
          ls -la _site/
      
      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v5
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_site

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
